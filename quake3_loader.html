<!doctype html>
<html lang="en">
    <head>
        <title>three.js webgl - geometry - minecraft - ao</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
        <style>
            body {
                color: #61443e;
                font-family:Monospace;
                font-size:13px;
                text-align:center;

                /* background-color: #bfd1e5; */
                background-color: #ffffff;
                margin: 0px;
                overflow: hidden;
            }

            a { color: #a06851; }

            #info {
                position: absolute;
                top: 0px; width: 100%;
                padding: 5px;
            }

            #oldie {
                background:rgb(100,0,0) !important;
                color:#fff !important;
                margin-top:10em !important;
            }
            #oldie a { color:#fff }


            button { border:0; background:rgba(0,0,0,0.5); color:orange; cursor:pointer }
            button:hover { color:gold }
        </style>
    </head>
    <body>

        <div id="container"><br /><br /><br /><br /><br />Loading world...</div>
        <div id="info">
            
        </div>

        <script src="../three.js/build/Three.js"></script>

        <script src="../three.js/examples/js/Detector.js"></script>
        <script src="../three.js/examples/js/Stats.js"></script>

        <script>

            if (!Detector.webgl ) {

                Detector.addGetWebGLMessage();
                document.getElementById('container').innerHTML = "";

            }

            var fogExp2 = true;

            var container, stats;

            var camera, controls, scene, renderer;

            var mesh, mat;

            var clock = new THREE.Clock();

            var timeUniform = { type: "f", value: 1.0 };

            init();
            animate();

            function loadTexture( path ) {
                var image = new Image();
                image.onload = function () { texture.needsUpdate = true; };
                image.src = path;

                var texture  = new THREE.Texture( image, new THREE.UVMapping(), THREE.RepeatWrapping, THREE.RepeatWrapping, THREE.LinearFilter, THREE.LinearMipMapLinearFilter );

                return new THREE.MeshLambertMaterial( { map: texture, ambient: 0x222222 } );
            }

            function init() {

                container = document.getElementById( 'container' );

                scene = new THREE.Scene();
                //scene.fog = new THREE.FogExp2( 0xffffff, 0.00015 );

                camera = new THREE.PerspectiveCamera( 50, window.innerWidth / window.innerHeight, 1, 20000 );
                scene.add( camera );

                controls = new THREE.FirstPersonControls( camera );

                controls.movementSpeed = 1000;
                controls.lookSpeed = 0.125;
                controls.lookVertical = true;
                controls.constrainVertical = true;
                controls.verticalMin = 1.1;
                controls.verticalMax = 2.2;

                //var debugMaterial = loadTexture("demo_baseq3/debug.png");

                var loader = new THREE.JSONLoader();
                loader.load( "exporter/output.js", function( geometry ) {
                    initMaterials("exporter/material-output.js", function(materials) {
                        geometry.materials = materials;
                        var mesh = new THREE.Mesh( geometry, new THREE.MeshFaceMaterial() );
                        scene.add( mesh );
                    });
                });

                var ambientLight = new THREE.AmbientLight( 0x222222 );
                scene.add( ambientLight );

                var directionalLight = new THREE.DirectionalLight( 0xffffff, 2 );
                directionalLight.position.set( 1, 1, 0.5 ).normalize();
                scene.add( directionalLight );

                renderer = new THREE.WebGLRenderer( { clearColor: 0x010101 } );
                renderer.setSize( window.innerWidth, window.innerHeight );

                container.innerHTML = "";

                container.appendChild( renderer.domElement );

                stats = new Stats();
                stats.domElement.style.position = 'absolute';
                stats.domElement.style.top = '0px';
                container.appendChild( stats.domElement );

            }

            function initMaterials(url, callback) {
                var request = new XMLHttpRequest();
    
                request.addEventListener("load", function () {
                    var materials = JSON.parse(request.responseText);
                    var matList = buildMaterialList(materials);
                    callback(matList);
                }, false);
                
                request.open('GET', url, true);
                request.setRequestHeader('Content-Type', 'text/json');
                request.send(null);
            }

            function buildMaterialList(materials) {
                var i, matList = [];

                for(i in materials) {
                    matList.push(materialToShader(materials[i]));
                }

                return matList;
            }

            function materialToShader(material) {
                var i, uniform, src, uniforms = {};

                for(i in material.uniforms) {
                    uniform = material.uniforms[i];

                    if(i == "time" && uniform.type == "f") {
                        uniform = timeUniform;
                    }
                    
                    if(uniform.type == "t") {
                        if(uniform.animTexture) {
                            src = uniform.animTexture[0];
                        } else {
                            src = uniform.texture;
                        }
                        
                        uniform.texture = THREE.ImageUtils.loadTexture( "demo_baseq3/" + src );
                        uniform.texture.wrapS = uniform.texture.wrapT = uniform.clamp ? THREE.ClampToEdgeWrapping : THREE.RepeatWrapping;
                    }

                    uniforms[i] = uniform;
                }

                return new THREE.ShaderMaterial({
                    uniforms: uniforms,
                    vertexColors: true,
                    vertexShader: material.vertexShader,
                    fragmentShader: material.fragmentShader,
                    transparent: material.transparent ? true : false
                });
            }

            function animate() {
                requestAnimationFrame( animate );

                render();
                stats.update();
            }

            function render() {
                var delta = clock.getDelta();
                timeUniform.value += delta;

                controls.update( delta );
                renderer.render( scene, camera );
            }

        </script>

    </body>
</html>
